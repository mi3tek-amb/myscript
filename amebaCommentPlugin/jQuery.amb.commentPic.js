/* jQuery.commentPic.js
 *
 * The MIT License (MIT) Copyright (c) 2012-2014
 * copyright : Mistuki Suzuki
 */
(function(b){b.fn.commentPic=function(e){var e=b.extend({id:null,pics:true,profile:false,blog:false,now:false,noImage:"http://ameblo.mi2log.com/common_image/guest_img.gif"},e);var f=new Array,a=b.fn.commentPic.fn;b.fn.commentPic.jsons=new Array;b(this).find("li").each(function(){var v=0,id=$('.commentBtn').data('entryid'),w=encodeURIComponent("#"),F=b(this),d=F.find(".commentBody"),G=F.find(".commentHeader"),y=F.find(".blogComment"),A=F.find(".commentFooter"),C=F.find(".commentAuthor"),H=F.find(".commentReply"),D=d.text().match(/\[.+\]\(#(c\d+)\)/),c=F.find("a").eq("0").attr("name").replace("c",""),z=C.text(),B=C[0]!==void 0?C.attr("href"):void 0,E=B?B.replace("http://","").split("/")[1]:"Guest",i="http://comment.ameba.jp/public/comment/displaycommentform.do?eid="+id+"&bnm=miumiu3tek&comment_text=[>"+z+"さま]("+w+"c"+c+")",A=b('<div class="menu">').insertAfter(A);G.html(G.text().replace(/[0-9]+?\./,'<span style="color:#aaa;line-height:1.5">title : <br></span>'));F.addClass("c"+c);y.addClass(E+"Comment");H.on("click",function(){window.open(i,"コメント","width=400, height=600, location=no, menubar=no, toolbar=no, scrollbars=yes");return false});if(!a.duplicate(f,E)){f.push(E)}if(D){F.data("cid",D[1])}d.html(marked(d.html().replace(/<br\/?>/g,"\n"))).find("pre").syntaxHiliter().end();F.append('<ul class="replyWrap">');var c=F.data("cid"),x=b("."+c);if(c){if(y.hasClass("miumiu3tekComment")){x.find(".replyWrap").eq(0).prepend(b(this).addClass("reply"))}else{x.find(".replyWrap").eq(0).append(b(this).addClass("reply"))}}});b.each(f,function(){var c=this,o=b("."+c+"Comment"),m=o.find(".menu");if(e.pics){var l=m.attr("href");if(c=="Guest"){var d=b("<img>",{src:e.noImage});a.appendImg(d,o.find(".commentBody"))}else{if(c==e.id){var p=b(".userProfileImage").find("img").attr("src"),d=b("<a>",{href:"http://profile.ameba.jp/"+c+"/"});d.append(b("<img>",{src:p}));a.appendImg(d,o.find(".commentBody"))}else{var n="http://profile.ameba.jp/"+c+"/";b.get("http://ameblo.mi2log.com/api/cross_domain_userimage?url="+n).done(function(h){if(!h){var i=b("<img>",{src:e.noImage})}else{var g=a.shortedImg+h.replace("http://",""),i=b("<a>",{href:n});i.append(b("<img>",{src:g}))}a.appendImg(i,o.find(".commentBody"))})}}}})};b.fn.commentPic.fn={duplicate:function(f,g){for(var a=0;a<f.length;a++){if(g.toLowerCase()==f[a].toLowerCase()){return true}}return false},shortedImg:"http://imgstat.ameba.jp/view/d/200/",appendImg:function(d,a){a.after(b("<div class=authpic>").append(d))},nameRep:function(e,f){var a=encodeURIComponent(f).replace(/\%/g,"x");return"["+e+"](http://profile.ameba.jp/"+b.fn.commentPic.jsons[a]+")\n\n"}}})(jQuery);